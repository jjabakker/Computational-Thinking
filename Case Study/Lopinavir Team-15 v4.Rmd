---
title: "Lopinavir"
author: "Prepared by Eline Been, Judith Frikking and Hans Bakker"
date: "9/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse)
p_load(ggplot2)
p_load(readxl)
p_load(gridExtra)
p_load(modelr)
p_load(knitr)
p_load(kable)
p_load(kableExtra)
theme_set(theme_minimal())
```

# Data capture

The experiment data is supplied in an excel file “Lopinavir_Pregnancy.xlsx”. Data is retrieved from two sheets and brought in the desired format.

```{r Read the files, include =  FALSE}

getwd()

# lsx1 = read_excel(path = "./Case Study/Lopinavir_Pregnancy.xlsx",
#                   sheet = "Patient Characteristics",
#                   col_names = T)
# lsx2 = read_excel(path = "./Case Study/Lopinavir_Pregnancy.xlsx", 
#                   sheet = "Concentrations",
#                   col_names = T, 
#                   skip = 1)

lsx1 <- read_excel(path = "Lopinavir_Pregnancy.xlsx",
                   sheet = "Patient Characteristics",
                   col_names = T)
lsx2 <- read_excel(path = "Lopinavir_Pregnancy.xlsx", 
                   sheet = "Concentrations",
                   col_names = T, 
                   skip = 1)
```


```{r Convert Lopinavir, include = FALSE}

# Ensure the column names match and do the join
colnames(lsx2)[colnames(lsx2) == "...1"] <- "ID" 
Lopinavir <- left_join(lsx1, lsx2)

# Rename columns to the required values
colnames(Lopinavir)[colnames(Lopinavir) == "pregnant (1=yes)"] <- "PREGNANT"
colnames(Lopinavir)[colnames(Lopinavir) == "age"] <- "AGE"

Lopinavir <- Lopinavir %>%
  gather(key = "TIME", value = "CONC", c(`1 hr`:`8 hr`)) %>%  # Make a long table
  select('ID', 'TIME', 'CONC', 'PREGNANT', 'AGE') %>%         # Reorder the columns
  arrange(ID) %>%                                             # Sort by ID
  separate('TIME', c("TIME","delete")) %>%                    # Split out the TIME field
  select(-'delete')                                           # Remove the column you do not need

# Set the logical formats
#Lopinavir$PREGNANT <- as.factor(Lopinavir$PREGNANT)
Lopinavir$PREGNANT <- as.logical(Lopinavir$PREGNANT)
Lopinavir$ID       <- as.factor(Lopinavir$ID)
Lopinavir$TIME     <- as.numeric(Lopinavir$TIME)
Lopinavir$AGE      <- as.integer(Lopinavir$AGE)

head(Lopinavir)

glimpse(Lopinavir)

count(Lopinavir, ID)
count(Lopinavir, TIME)
count(Lopinavir, AGE)
count(Lopinavir, PREGNANT)
count(Lopinavir, CONC)

summary(Lopinavir)

```

In the table below the first 6 data out of 128 records are displayed. Measurements are presented for 32 women:

* 8 pregnant, above 35
* 8 pregnant, below 35
* 8 not pregnant, above 35
* 8 not pregnant, above 35

For each individual, 4 measurements of concentration are provided at times 1, 2, 4 and 8.


```{r Display results, echo = FALSE}
Lopinavir %>%
  head () %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, 
                position = "center")
```


```{r Plot Lopinavir data - version 1, include =  FALSE}

# Add columns to the Lopinavir table for easy selection 
Lopinavir

Lopinavir$P_P35  <- Lopinavir$PREGNANT == 1 & Lopinavir$AGE > 35
Lopinavir$NP_P35 <- Lopinavir$PREGNANT == 1 & Lopinavir$AGE <= 35
Lopinavir$P_M35  <- Lopinavir$PREGNANT == 0 & Lopinavir$AGE > 35
Lopinavir$NP_M35 <- Lopinavir$PREGNANT == 0 & Lopinavir$AGE <= 35
Lopinavir$Age35  <- Lopinavir$AGE <= 35

pset_P_P35   <- filter(Lopinavir, Lopinavir$P_P35 == T)
pset_NP_P35  <- filter(Lopinavir, Lopinavir$NP_P35 == T)
pset_P_M35   <- filter(Lopinavir, Lopinavir$P_M35 == T)
pset_NP_M35  <- filter(Lopinavir, Lopinavir$NP_M35 == T)

count(Lopinavir, Lopinavir$PREGNANT == 1 & Lopinavir$AGE > 35)
count(Lopinavir, Lopinavir$PREGNANT == 1 & Lopinavir$AGE <= 35)
count(Lopinavir, Lopinavir$PREGNANT == 0 & Lopinavir$AGE > 35)
count(Lopinavir, Lopinavir$PREGNANT == 0 & Lopinavir$AGE <= 35)
 
pn <- ggplot() +
  geom_point(data = pset_P_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1, colour = 'red') +
  geom_smooth(data = pset_P_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'red',
             linetype = 'solid',
             method='lm', se = FALSE) +
  geom_point(data = pset_NP_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1,
             colour = 'black') + 
  geom_smooth(data = pset_NP_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'black',
             linetype = 'solid',
             method='lm', se = FALSE) +
  geom_point(data = pset_P_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1,
             colour = 'red') +
  geom_smooth(data = pset_P_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'red',
             linetype = 'dashed',
             method='lm', se = FALSE) +
  geom_point(data = pset_NP_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1, colour = 'black') +
  geom_smooth(data = pset_NP_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'black',
             linetype = 'dashed',
             method='lm', se = FALSE) +
  labs(color = "Patient") +
  labs(x = "Time") +
  labs(y = "Concentration") +
  labs(title = "New Plot", subtitle = "New subtitle") +
  labs(caption = "(based on data from ...)")

pl <- pn +
  scale_y_continuous(trans='log', breaks = c(1, 5, 10)) +
  labs(y = "Log Concentration") 
```

```{r, include = FALSE}

#
# This picture does not anything, so leave it out
#

gridExtra::grid.arrange(
    pl,
    pn,
    nrow = 1)

```

The data is graphically presented in the panel below, where for each of the four groups, (connected) data points are shown. Note the use of a logarithmic scale for the Concentration. In all four plots can be see that with time the concentration reduces. 

```{r Plot Lopinavir data - version 2, echo =  FALSE}

Lopinavir$Group  <- "Code"   # Create a 

for (i in 1:nrow(Lopinavir)) {
  if (Lopinavir[i,]$PREGNANT == TRUE) {
    if (Lopinavir[i,]$AGE > 35) {
      Lopinavir[i,]$Group = "Pregnant > 35"
    } else {
      Lopinavir[i,]$Group = "Pregnant <= 35"
    }
  }
  else {
    if (Lopinavir[i,]$AGE > 35) {
      Lopinavir[i,]$Group = "Not Pregnant > 35"
    } else {
      Lopinavir[i,]$Group = "Not Pregnant <= 35"
    }
  }
}

ggplot(data = Lopinavir, 
       mapping = aes(x = TIME, y = CONC)) +
  geom_point(size = 1, colour = 'red') +
  geom_path(size = 0.1) +
  labs(color = "Patient") +
  labs(x = "Time") +
  scale_y_continuous(trans='log', breaks = c(1, 5, 10)) +
  labs(y = "Log Concentration") +
  labs(title = "New Plot", subtitle = "New subtitle") +
  labs(caption = "(based on data from ...)") +
  facet_wrap( ~ Group, ncol = 2) +
  theme(panel.spacing = unit(1.5, "lines"))
  
```



```{r Question 4, include =  FALSE}

# The concentration-time data reveals a linear profile on a semi-logarithmic scale. 
# To be able to perform a linear regression add a new column to the dataset that contains the 
# LN-values of the concentrations.

Lopinavir <- mutate(Lopinavir, log(CONC))
colnames(Lopinavir)[colnames(Lopinavir) == "log(CONC)"] <- "log_of_CONC"
```


Visually there appear to be different average slopes for the four groups. The summary table below displays the average slopes for each group and confirms that impression.


```{r Patient Table, include =  FALSE}
patient_table <- unique(select(Lopinavir, ID, Group))
patient_table$slope = 0

for (i in 1: nrow(patient_table)) {
  t <- filter(Lopinavir, ID == i)
  n = lm (data = t, log_of_CONC ~ TIME)
  patient_table[i,]$slope = coef(n)[2]
}

slope_table <- patient_table %>%
  group_by(Group) %>%
  summarise("Average slope" = mean(slope))
```

```{r, echo = FALSE }
slope_table %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, 
                position = "center")
```

The slopes of the individual measurements for all 32 individuals are displayed in the table below.

```{r, echo = FALSE }
patient_table %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, 
                position = "center")
```



```{r Define Linear Models, include =  FALSE}

Lopinavir$Age35  = Lopinavir$AGE <= 35

lm_age                           <- lm(data = Lopinavir, log(CONC) ~ Age35)
lm_pregnant                      <- lm(data = Lopinavir, log(CONC) ~ PREGNANT)
lm_time                          <- lm(data = Lopinavir, log(CONC) ~ TIME)
lm_time_times_pregnant           <- lm(data = Lopinavir, log(CONC) ~ TIME * PREGNANT)
lm_time_times_age                <- lm(data = Lopinavir, log(CONC) ~ TIME * Age35)
lm_time_times_age_times_pregnant <- lm(data = Lopinavir, log(CONC) ~ TIME * Age35 *  PREGNANT)
```

```{r View Linear Models, include =  FALSE}

lm_age
lm_pregnant
lm_time
lm_time_times_pregnant
lm_time_times_age
lm_time_times_age_times_pregnant
```

```{r View summary linear model, include =  FALSE}

summary(lm_age)
summary(lm_pregnant)
summary(lm_time)
summary(lm_time_times_pregnant)
summary(lm_time_times_age)
summary(lm_time_times_age_times_pregnant)
```

```{r Anova Analyse, include =  FALSE}

anova(lm_age,
      lm_pregnant,
      lm_time,
      lm_time_times_pregnant,
      lm_time_times_age,
      lm_time_times_age_times_pregnant)
```





# Question 6 
Fit a linear model to the ln-transformed concentration values of all individual patients in all four patient types (pregnant & younger than 35 years, pregnant & older than 35 years, non-pregnant & younger than 35 years, non-pregnant & older than 35 years) and make a table that includes ID number, patient type, and the slope of the linear fit. This slope represents the elimination rate constant of lopinavir.

# Question 7
Perform an ANOVA analysis and provide an interpretation of the results regarding the research question of whether the elimination rate constant of lopinavir is statistically significantly different in the four patient types.





```{r Cool plot 2, echo =  FALSE}
data_to_predict_3 <- Lopinavir %>% 
  data_grid(Age35, PREGNANT, TIME) %>%
  gather_predictions(lm_age,
                     lm_time,
                     lm_pregnant,
                     lm_time_times_age,
                     lm_time_times_pregnant,
                     lm_time_times_age_times_pregnant,
                     .pred = "log_of_CONC") %>% mutate(
                       model = factor(model,
                                      levels = c("lm_age",
                                                 "lm_time",
                                                 "lm_pregnant",
                                                 "lm_time_times_age",
                                                 "lm_time_times_pregnant",
                                                 "lm_time_times_age_times_pregnant"),
                                      labels = c("Conc - Age", 
                                                 "Conc - Time", 
                                                 "Conc - Pregnant",
                                                 "Conc - Age * Time",
                                                 "Conc - Pregnant * Time",
                                                 "Conc - Time * Age * Pregnant"),
                                      ordered = T))

ggplot(data = Lopinavir, 
       aes( x= TIME, y = log_of_CONC, color = interaction(Age35,PREGNANT))) +
  geom_boxplot(aes(group = interaction(TIME, Group, Age35, PREGNANT))) + 
    geom_line(data = data_to_predict_3,
              aes(x= TIME, y = log_of_CONC, group = interaction(Age35,PREGNANT))) + 
  labs(x = "Time") +
  labs(y = "Concentration") +
  labs(title = "New Plot", subtitle = "New subtitle") +
  labs(caption = "(based on data from ...)") +
  theme(legend.position = "bottom") +
  theme(legend.text = element_text(size = 6)) +
  theme(legend.title = element_text(size = 6)) +
  facet_wrap(~ model)
```




