---
title: "Lopinavir"
author: "Hans"
date: "9/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse)
p_load(ggplot2)
p_load(maggrittr)
p_load(readxl)
p_load(gridExtra)
theme_set(theme_minimal())
```

# Question 1
You have received an excel file “Lopinavir_Pregnancy.xlsx.” which contains all relevant information in different sheet. Read in all data in R and describe the design of the study.

```{r Read the data}

getwd()

# lsx1 = read_excel(path = "./Case Study/Lopinavir_Pregnancy.xlsx",
#                   sheet = "Patient Characteristics",
#                   col_names = T)
# lsx2 = read_excel(path = "./Case Study/Lopinavir_Pregnancy.xlsx", 
#                   sheet = "Concentrations",
#                   col_names = T, 
#                   skip = 1)

lsx1 <- read_excel(path = "Lopinavir_Pregnancy.xlsx",
                   sheet = "Patient Characteristics",
                   col_names = T)
lsx2 <- read_excel(path = "Lopinavir_Pregnancy.xlsx", 
                   sheet = "Concentrations",
                   col_names = T, 
                   skip = 1)
```

# Question 2
The software that you are going to use to analyze the data needs the format to be as indicated below.

```{r Convert Lopinavir}

# Ensure the column names match and do the join
colnames(lsx2)[colnames(lsx2) == "...1"] <- "ID" 
Lopinavir <- left_join(lsx1, lsx2)

# Rename columns to the required values
colnames(Lopinavir)[colnames(Lopinavir) == "pregnant (1=yes)"] <- "PREGNANT"
colnames(Lopinavir)[colnames(Lopinavir) == "age"] <- "AGE"

Lopinavir <- Lopinavir %>%
  gather(key = "TIME", value = "CONC", c(`1 hr`:`8 hr`)) %>%  # Make a long table
  select('ID', 'TIME', 'CONC', 'PREGNANT', 'AGE') %>%         # Reorder the columns
  arrange(ID) %>%                                             # Sort by ID
  separate('TIME', c("TIME","delete")) %>%                    # Split out the TIME field
  select(-'delete')                                           # Remove the column you do not need

# Set the logical formats
Lopinavir$PREGNANT <- as.factor(Lopinavir$PREGNANT)
Lopinavir$ID       <- as.factor(Lopinavir$ID)
Lopinavir$TIME     <- as.numeric(Lopinavir$TIME)
Lopinavir$AGE      <- as.integer(Lopinavir$AGE)

head(Lopinavir)

glimpse(Lopinavir)

count(Lopinavir, ID)
count(Lopinavir, TIME)
count(Lopinavir, AGE)
count(Lopinavir, PREGNANT)
count(Lopinavir, CONC)

summary(Lopinavir)

```

# Question 3

Plot the concentration-time data for all patients and use different colors for pregnant and non-pregnant women and different line types for women older and younger than 35. Do this on a linear scale and semi-logarithmic scale

```{r Plot Lopinavir data - version 1}

# Add columns to the Lopinavir table for easy selection 
Lopinavir

Lopinavir$P_P35  <- Lopinavir$PREGNANT == 1 & Lopinavir$AGE > 35
Lopinavir$NP_P35 <- Lopinavir$PREGNANT == 1 & Lopinavir$AGE <= 35
Lopinavir$P_M35  <- Lopinavir$PREGNANT == 0 & Lopinavir$AGE > 35
Lopinavir$NP_M35 <- Lopinavir$PREGNANT == 0 & Lopinavir$AGE <= 35
Lopinavir$Age35  <- Lopinavir$AGE <= 35

pset_P_P35   <- filter(Lopinavir, Lopinavir$P_P35 == T)
pset_NP_P35  <- filter(Lopinavir, Lopinavir$NP_P35 == T)
pset_P_M35   <- filter(Lopinavir, Lopinavir$P_M35 == T)
pset_NP_M35  <- filter(Lopinavir, Lopinavir$NP_M35 == T)

 
pn <- ggplot() +
  geom_point(data = pset_P_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1, colour = 'red') +
  geom_smooth(data = pset_P_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'red',
             linetype = 'solid',
             method='lm', se = FALSE) +
  geom_point(data = pset_NP_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1,
             colour = 'black') + 
  geom_smooth(data = pset_NP_P35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'black',
             linetype = 'solid',
             method='lm', se = FALSE) +
  geom_point(data = pset_P_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1,
             colour = 'red') +
  geom_smooth(data = pset_P_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'red',
             linetype = 'dashed',
             method='lm', se = FALSE) +
  geom_point(data = pset_NP_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 1, colour = 'black') +
  geom_smooth(data = pset_NP_M35,
             mapping = aes(x = TIME, y = CONC), 
             size = 0.5, colour = 'black',
             linetype = 'dashed',
             method='lm', se = FALSE) +
  labs(color = "Patient") +
  labs(x = "Time") +
  labs(y = "Concentration") +
  labs(title = "New Plot", subtitle = "New subtitle") +
  labs(caption = "(based on data from ...)")

pl <- pn +
  scale_y_continuous(trans='log', breaks = c(1, 5, 10)) +
  labs(y = "Log Concentration") 

gridExtra::grid.arrange(
    pl,
    pn,
    nrow = 1)

pl

```




```{r Plot Lopinavir data - version 2}

Lopinavir$Group  <- "Code"   # Create a 

for (i in 1:nrow(Lopinavir)) {
  if (Lopinavir[i,]$PREGNANT == "1") {
    if (Lopinavir[i,]$AGE > 35) {
      Lopinavir[i,]$Group = "Pregnant > 35"
    } else {
      Lopinavir[i,]$Group = "Pregnant <= 35"
    }
  }
  else {
    if (Lopinavir[i,]$AGE > 35) {
      Lopinavir[i,]$Group = "Not Pregnant > 35"
    } else {
      Lopinavir[i,]$Group = "Not Pregnant <= 35"
    }
  }
}

ggplot(data = Lopinavir, 
       mapping = aes(x = TIME, y = CONC)) +
  geom_point(size = 1, colour = 'red') +
  geom_path() +
  labs(color = "Patient") +
  labs(x = "Time") +
  scale_y_continuous(trans='log', breaks = c(1, 5, 10)) +
  labs(y = "Log Concentration") +
  labs(title = "New Plot", subtitle = "New subtitle") +
  labs(caption = "(based on data from ...)") +
  facet_wrap( ~ Group, ncol = 2)
  #facet_grid( ~ Group, margins = T )
  
```


# Question 4
The concentration-time data reveals a linear profile on a semi-logarithmic scale. To be able to perform a linear regression add a new column to the dataset that contains the LN-values of the concentrations.

```{r}
mutate(Lopinavir, log(CONC))
```

# Question 5
Fit a linear model to the ln-transformed concentration values of both treatment arms. The peak concentration is mainly determined by the distribution volume of lopinavir, while the slope of the profiles is mainly determined by the elimination rate constant. Do you anticipate differences in elimination rate constants between pregnant and non-pregnant women? And between woman older and younger than 35 years.

```{r Linear Models}

Lopinavir$Age35  = Lopinavir$AGE <= 35

lm_pregnant           <- lm(data = Lopinavir, log(CONC) ~ PREGNANT)
lm_age                <- lm(data = Lopinavir, log(CONC) ~ Age35)
lm_pregnant_plus_age  <- lm(data = Lopinavir, log(CONC) ~ Age35 + PREGNANT)
lm_pregnant_times_age <- lm(data = Lopinavir, log(CONC) ~ Age35 * PREGNANT)

lm_pregnant
lm_age
lm_pregnant_plus_age
lm_pregnant_times_age

summary(lm_pregnant)
summary(lm_age)
summary(lm_pregnant_plus_age)
summary(lm_pregnant_times_age)

```

```{r}
anova(lm_pregnant,          lm_age)
anova(lm_pregnant,          lm_pregnant_plus_age)
anova(lm_pregnant,          lm_pregnant_times_age)
anova(lm_age,               lm_pregnant_plus_age)
anova(lm_age,               lm_pregnant_times_age)
anova(lm_pregnant_plus_age, lm_pregnant_times_age)

```

```{r}
par(mfrow=c(2,2))
boxplot(data = Lopinavir, log(CONC) ~ Age35 * PREGNANT, main = "Test")
par(mfrow=c(1,1))

```

# Question 6 
Fit a linear model to the ln-transformed concentration values of all individual patients in all four patient types (pregnant & younger than 35 years, pregnant & older than 35 years, non-pregnant & younger than 35 years, non-pregnant & older than 35 years) and make a table that includes ID number, patient type, and the slope of the linear fit. This slope represents the elimination rate constant of lopinavir.

# Question 7
Perform an ANOVA analysis and provide an interpretation of the results regarding the research question of whether the elimination rate constant of lopinavir is statistically significantly different in the four patient types.


grid2 <- ChickWeight %>%
  data_grid(Diet, Time) %>%                    # (1)
  gather_predictions(chicken_model_Diet,       # (2)
                     chicken_model_Time, 
                     chicken_model_both, 
                     chicken_model_full, 
                     .pred = "weight") %>% 
  mutate(model = factor(model,                 # (3)
                        levels = c("chicken_model_Diet", "chicken_model_Time",
                                   "chicken_model_both", "chicken_model_full"), 
                        labels = c("weight~Diet", "weight~Time", "weight~Time+Diet",
                                   "weight~Time*Diet"), 
                        ordered = T)
)

ggplot(data = ChickWeight, 
       aes( x = Time, y = weight, color = Diet)) +
  geom_boxplot(aes(group = interaction(Time, Diet))) + 
  geom_line(data = grid2) + 
  facet_wrap(~ model)
  
  
```{r Compare models by plotting the original data in the models}

# Create data to predict
data_to_predict <- Lopinavir

# Do the prediction with the various models
p <- gather_predictions(data_to_predict,
                        lm_age,   
                        lm_pregnant, 
                        lm_pregnant_plus_age, 
                        lm_pregnant_times_age, 
                        .pred = "CONC")

mutate(p, model = factor(model,
                         levels = c("lm_age", 
                                    "lm_pregnant",
                                    "lm_pregnant_plus_age", 
                                    "lm_pregnant_times_age"),
                         labels = c("Conc - Age", 
                                    "Conc - Pregnant", 
                                    "Conc - Age + Pregnant",
                                    "Conc - Age + Pregnant"),
                         ordered = T)
)

ggplot(data = Lopinavir, 
       aes( x = TIME, y = CONC, color = PREGNANT)) +
  geom_boxplot(aes(group = interaction(TIME, PREGNANT))) + 
  geom_line(data = p) + 
  facet_wrap(~ model)
```

